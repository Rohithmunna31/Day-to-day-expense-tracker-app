<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Add Expense</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.2.1/axios.min.js"></script>
  </head>
  <body>
    <form id="form">
      <label for="addexpense"> Choose ExpenseAmount </label>
      <input type="text" id="addexpense" />

      <label for="description"> Choose description </label>
      <input type="text" id="description" />

      <label for="category"> Choose category </label>
      <select name="category" id="category">
        <option value="Food">Food</option>
        <option value="Fuel">Fuel</option>
        <option value="Emi">Emi</option>
      </select>

      <button type="submit" id="submit">Add Expense</button>
    </form>

    <button id="premium">Buy Premimum</button>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <div id="expenses-list"></div>
    <script>
      const btn = document.getElementById("submit");

      btn.addEventListener("click", (e) => {
        e.preventDefault();

        const expense = document.getElementById("addexpense").value;
        const description = document.getElementById("description").value;
        const category = document.getElementById("category").value;
        const token = localStorage.getItem("token");
        axios
          .post(
            "/expense/addexpense",
            {
              expense: expense,
              description: description,
              category: category,
            },
            {
              headers: { Authorization: token },
            }
          )
          .then((res) => {
            console.log(res);
            const { id } = res.data;

            const expenseList = document.getElementById("expenses-list");
            const show = document.createElement("div");

            show.setAttribute("id", `data-${id}`);

            show.innerHTML = `<p> ${expense} <p/>
                              <p> ${description} <p/>
                              <p> ${category} <p/>
                              <button onclick="deleteExpense(${id})">Delete Expense</button>
                                <hr> `;

            console.log(show.getAttribute("id"));
            expenseList.appendChild(show);
          })
          .catch((err) => {
            console.log(err);
          });
      });

      window.addEventListener("load", async (e) => {
        try {
          const token = localStorage.getItem("token");
          const response = await axios.get("/expense/getexpenses", {
            headers: { Authorization: token },
          });

          console.log(response);
          const expenses = response.data;

          const expensesList = document.getElementById("expenses-list");

          expensesList.innerHTML = ""; // Clear previous data

          expenses.forEach((expense) => {
            const expenseItem = document.createElement("div");
            expenseItem.setAttribute("id", `data-${expense.id}`);
            expenseItem.innerHTML = `
            <p>${expense.expense}</p>
            <p>${expense.description}</p>
            <p>${expense.category}</p>
            <button onclick="deleteExpense(${expense.id})">Delete Expense </button>
            <hr>
          `;
            // console.log(expenseItem);
            console.log(expenseItem.getAttribute("id"));
            expensesList.appendChild(expenseItem);
          });
        } catch (error) {
          console.error("Error fetching expenses:", error);
        }
      });

      // Function to delete an expense
      async function deleteExpense(expenseId) {
        try {
          const expenseElement = document.querySelector(
            `#expenses-list [id=data-${expenseId}]`
          );
          // console.log(expenseElement);
          if (expenseElement) {
            expenseElement.remove();
          }
          const token = localStorage.getItem("token");
          await axios.delete(`/expense/delete/${expenseId}`, {
            headers: { Authorization: token },
          });
        } catch (error) {
          console.error("Error deleting expense:", error);
        }
      }

      document
        .getElementById("premium")
        .addEventListener("click", async (e) => {
          const token = localStorage.getItem("token");

          const response = await axios.get(
            "http:localhost:3000/purchase/buypremiummembershi",
            { heders: { Authorization: token } }
          );
          console.log(response);

          let options = {
            key: response.data.key_id,
            order_id: response.data.order.id,
            // This function will handle the success of payment
            handler: async function (response) {
              await axios.post(
                "http://localhost:3000/purchase/updatetransactionstatus",
                {
                  order_id: options.order_id,
                  payment_id: options.payment_id,
                },
                {
                  headers: { Authorization: token },
                }
              );

              alert("You are premium member now ");
            },
          };
          const rzp1 = new Razorpay(options);
          rzp1.open();
          e.preventDefault();

          rzp1.on("payment.failed", function (response) {
            console.log(response);
            alert("something went wrong");
          });
        });
    </script>
  </body>
</html>
